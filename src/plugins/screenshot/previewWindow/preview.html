<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; img-src 'self' data:;"> -->
    <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'" />
    <title>Screenshot Preview</title>

    <link rel="stylesheet" href="./preview.css">
</head>

<body>
    <main>
        <img id="screenshotImage" />
    </main>

    <div id="selectionBox" class="selection-box"></div>
    <script>
        const ONLINE_COLOR = " #19c10a";
        const OFFLINE_COLOR = " #FF3A52";


        document.addEventListener("DOMContentLoaded", () => {
            const screenshotImg = document.getElementById("screenshotImage");

            window.electron.onImageDataURL((imgDataURL) => {
                screenshotImg.src = imgDataURL;

                updateImageInfo();
                displayActionButtonsUI();
            });

            window.electron.onCroppedImage(imgDataURL => {
                screenshotImg.src = imgDataURL

                updateImageInfo();
            })
        });

        window.addEventListener("error", (msg, src, lineno, colno, err) => {
            console.error('msg: ', msg);
            console.error('source: ', src);
            console.error('line no.: ', lineno);
            console.error('column no.: ', colno);
            console.error('error: ', err);

            showErrorMessage("An unexpected error occurred.", msg);
            return true; // Prevent default error behavior
        });

        /**
         *
         * @param {*} opts
         * @returns {HTMLElement}
         */
        function createElement(opts) {
            const elem = document.createElement(opts.tagName);

            if (opts.type) elem.type = opts.type;
            if (opts.id) elem.id = opts.id;
            if (opts.textContent) elem.textContent = opts.textContent;

            opts.classes?.forEach((clsName) => elem.classList.add(clsName));

            Object.entries(opts.attributes || {}).forEach(([k, v]) => {
                elem.setAttribute(k, v);
            });

            return elem;
        }

        function displayActionButtonsUI() {
            const publishToSwarmBtn = publishToSwarmUI();

            const footer = createElement({
                tagName: "footer",
                id: "btnContainer",
                classes: ["btn-container"],
            });

            const cropBtn = createElement({
                tagName: "button",
                id: "cropBtn",
                textContent: "Crop Image",
            });
            cropBtn.onclick = () => {
                const screenshotImg = document.getElementById("screenshotImage");
                window.electron.openCropWindow(screenshotImg.src);
            };

            const saveToDiskBtn = createElement({
                tagName: "button",
                id: "saveToDiskBtn",
                textContent: "Save Image",
            });
            saveToDiskBtn.onclick = () => {
                const screenshotImg = document.getElementById("screenshotImage");
                window.electron.writeImageToDisk(screenshotImg.src);
            };

            [cropBtn, publishToSwarmBtn, saveToDiskBtn].forEach((elem) => {
                footer.insertAdjacentElement("beforeend", elem);
            });

            document.querySelector("main").insertAdjacentElement("afterend", footer);
        }

        function updateImageInfo() {
            let screenshotImg = document.getElementById("screenshotImage");
            let infoDiv = document.getElementById("fileBasicInfo");

            const img = new Image();
            img.src = screenshotImg.src;

            img.onload = () => {
                const width = img.width;
                const height = img.height;
                const fileSize =
                    ((screenshotImg.src.length * 3) / 4 -
                        screenshotImg.src.split(",")[1].length) *
                    0.75;

                const innerHTLM = `<p>Resolution: ${width} x ${height} 
      </p>
      <p>File Size: ${(fileSize / 1024).toFixed(2)} KB </p>`;

                if (infoDiv) {
                    infoDiv.innerHTML = innerHTLM;
                } else {
                    infoDiv = createElement({
                        tagName: "div",
                        id: "fileBasicInfo",
                        classes: ["file-basic-info"],
                    });
                    infoDiv.innerHTML = innerHTLM;
                    document
                        .getElementById("screenshotImage")
                        .insertAdjacentElement("afterend", infoDiv);
                }
            };
        }

        function connectionStatusUI() {
            const div = createElement({ tagName: "div", classes: ["cnx-div"] });

            const cnxIcon = createElement({
                tagName: "span",
                classes: ["cnx-icon"],
                id: "cnxIcon",
            });

            const cnxStatus = createElement({
                tagName: "p",
                id: "cnxStatus",
                class: "cnx-status",
            });
            cnxStatus.append(spinnerUI());
            div.append(cnxIcon, cnxStatus);

            return div;
        }

        function checkConnection(connected) {
            try {
                if (connected) {
                    updateConnectionStatusUI(connected, "Connected");
                } else {
                    updateConnectionStatusUI(
                        connected,
                        "Not Connected",
                        "Check if your Bee Node running."
                    );
                }
            } catch (err) {
                console.error("Error checking connection:", err);
                updateConnectionStatusUI(connected, "Not Connected", err.message);
            }
        }

        /**
         * @dev Update the UI with the connection status
         * @param {boolean} connected The result of node active status
         * @param {string} status The display status 'connected' | 'Not connected'
         * @param {string} description A description for the node status
         */
        function updateConnectionStatusUI(connected, status, description) {
            const cnxIcon = document.getElementById("cnxIcon");
            if (cnxIcon) {
                cnxIcon.style.backgroundColor = connected ? ONLINE_COLOR : OFFLINE_COLOR;
            }

            const cnxStatus = document.getElementById("cnxStatus");
            if (cnxStatus) {
                cnxStatus.innerText = status;
                if (description) {
                    document.getElementById(
                        "modalMain"
                    ).innerHTML = `<h2>${description}</h2>`;
                }
            }
        }

        function openModalUI() {
            const cnxStatus = connectionStatusUI(); // Initialize the UI to show the connection status

            const modal = createElement({
                tagName: "div",
                id: "modal",
                classes: ["modal"],
            });

            const closeIcon = createElement({
                tagName: "span",
                id: "closeIcon",
                classes: ["close-icon"],
            });
            closeIcon.innerHTML = "&times;";
            closeIcon.addEventListener("click", () => {
                modal.parentNode.removeChild(modal);
            });

            const moadalContent = createElement({
                tagName: "div",
                classes: ["modal-content"],
            });

            const header = createElement({ tagName: "div", classes: ["modal-header"] });
            header.append(cnxStatus, closeIcon);

            const modalMain = createElement({
                tagName: "div",
                classes: ["modal-main"],
                id: "modalMain",
            });

            moadalContent.append(header, modalMain);
            modal.insertAdjacentElement("beforeend", moadalContent);

            return modal;
        }

        function publishToSwarmUI() {
            let cnxCheckIntervalId;

            const publishToSwarmBtn = createElement({
                tagName: "button",
                textContent: "Publish to Swarm",
                id: "PublishToSwarm",
            });

            publishToSwarmBtn.addEventListener("click", async () => {
                window.electron.setTitle("Publish to Swarm Network");

                const openModal = openModalUI();
                openModal.style.display = "block";
                const modalContent = openModal.getElementsByClassName("modal-main")[0];
                document.body.appendChild(openModal);



            });

            return publishToSwarmBtn;
        }

        function spinnerUI(width = "18px", height = "18px", borderColor) {
            const div = createElement({
                tagName: "div",
                classes: ["spinner-container"],
            });

            const span = createElement({
                tagName: "span",
                classes: ["spinner"],
            });
            span.style.width = width;
            span.style.height = height;
            span.style.borderColor = borderColor;

            div.appendChild(span);

            return div;
        }

        /**
           * This function list the available/ usable postage stamp
           * @param {Element} modalContent
           * 
           */
        async function postageStampUI(modalContent) {
            if (modalContent.firstChild) {
                modalContent.removeChild(modalContent.firstChild);
            }

            const container = createElement({ tagName: "div", classes: ["container"] });
            const row = createElement({
                tagName: "div",
                classes: ["row"],
                name: "listPostageStamp",
            });
            const h2 = createElement({ tagName: "h2" });
            const spinnerContainer = spinnerUI((width = "36px"), (height = "36px"));

            try {
                const psBatches = await window.electron.getAllPostageBatch();

                if (psBatches.length) {
                    listAvailableStampUI(h2, psBatches, container, row, modalContent);
                } else {
                    h2.textContent = "No Postage stamp available";
                    container.insertAdjacentElement("beforeend", h2);

                    const openBeeDashboardBtn = createElement({
                        tagName: "button",
                        textContent: "Create Stamp",
                        classes: ["btn"],
                    });

                    container.insertAdjacentElement("beforeend", openBeeDashboardBtn);

                    openBeeDashboardBtn.onclick = function () {
                        openBeeDashboardBtn.disabled = true;
                        openBeeDashboardBtn.style.cursor = "wait";

                        container.insertAdjacentElement("beforeend", spinnerContainer);
                        window.electron.createPostageStamp();

                        // keep watch for new purchase
                        const updatePostageStampStateIntervalId = setInterval(() => {
                            window.electron.updatePostageStampState((ps) => {
                                if (ps.length) {
                                    clearInterval(updatePostageStampStateIntervalId);
                                    document.body.removeChild(spinnerContainer);

                                    h2.textContent = `Select from available stamps (${ps?.length})`;

                                    openBeeDashboardBtn.disabled = false;
                                    openBeeDashboardBtn.hidden = true;

                                    listAvailableStampUI(h2, ps, container, row, modalContent);
                                }
                            });
                        }, 5000);
                    };

                    row.insertAdjacentElement("afterbegin", container);
                    modalContent.insertAdjacentElement("beforeend", row);
                }
            } catch (err) {
                console.error(err);
                showErrorMessage(err.message);
            }
        }

        function showErrorMessage(msg) {
            const errMsg = createElement({
                tagName: "p",
                classes: ["error-msg"],
                textContent: msg,
            });

            document.body.appendChild(errMsg);

            setTimeout(() => {
                document.body.removeChild(errMsg);
            }, 5000);
        }


    </script>
</body>

</html>