<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; img-src 'self' data:;"> -->
    <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'" />
    <title>Crop Image</title>
    <link rel="stylesheet" href="./crop.css">
</head>

<body>
    <main>
        <div class="image-container">
            <img class="crop-image" id="cropImage">
            <div class="overlay"></div>
            <div id="selectionBox">
                <div class="resize-handle bottom-right"></div>
                <div class="resize-handle bottom-left"></div>
                <div class="resize-handle top-right"></div>
                <div class="resize-handle top-left"></div>
            </div>
        </div>

    </main>
    <footer>
        <button id="cropBtn">Crop</button>
    </footer>
    <script>
        /**
         *
         * @param {*} opts
         * @returns {HTMLElement}
         */
        function createElement(opts) {
            const elem = document.createElement(opts.tagName);

            if (opts.type) elem.type = opts.type;
            if (opts.id) elem.id = opts.id;
            if (opts.textContent) elem.textContent = opts.textContent;

            opts.classes?.forEach((clsName) => elem.classList.add(clsName));

            Object.entries(opts.attributes || {}).forEach(([k, v]) => {
                elem.setAttribute(k, v);
            });

            return elem;
        }



        /**
         * Get dimension of the image
           * @param {HTMLImageElement} cropImage
           * @returns {width, height}
           */
        function getImageBounds(cropImage) {
            const imgBounds = cropImage.getBoundingClientRect();
            return {
                width: imgBounds.width,
                height: imgBounds.height,
            };
        }

        /**
         * Draggable logic for the selection box
         * @param {HTMLElement} selBox
         * @param {HTMLImageElement} cropImage
         */
        function initSelectionBoxMovement(selBox, cropImage) {

            selBox.addEventListener("mousedown", (e) => {
                e.preventDefault();

                const initialMouseX = e.clientX;
                const initialMouseY = e.clientY;

                const initialLeft = parseFloat(selBox.style.left) || 0;
                const initialTop = parseFloat(selBox.style.top) || 0;

                function mouseMoveHandler(mEvent) {
                    const dx = mEvent.clientX - initialMouseX;
                    const dy = mEvent.clientY - initialMouseY;

                    let newLeft = initialLeft + dx;
                    let newTop = initialTop + dy;

                    const imgBounds = getImageBounds(cropImage);
                    const boxBounds = selBox.getBoundingClientRect();

                    // Constrain the selection box within the image bounds
                    if (newLeft < 0) {
                        newLeft = 0; // Prevent moving left out of bounds
                    }
                    if (newTop < 0) {
                        newTop = 0; // Prevent moving up out of bounds
                    }
                    if (newLeft + boxBounds.width > imgBounds.width) {
                        newLeft = imgBounds.width - boxBounds.width; // Prevent moving right out of bounds
                    }
                    if (newTop + boxBounds.height > imgBounds.height) {
                        newTop = imgBounds.height - boxBounds.height; // Prevent moving down out of bounds
                    }

                    selBox.style.left = `${newLeft}px`;
                    selBox.style.top = `${newTop}px`;
                }

                function mouseUpHandler() {
                    document.removeEventListener("mousemove", mouseMoveHandler);
                    document.removeEventListener("mouseup", mouseUpHandler);
                }

                document.addEventListener("mousemove", mouseMoveHandler);
                document.addEventListener("mouseup", mouseUpHandler);
            });


        }

        document.addEventListener("DOMContentLoaded", () => {
            const footer = document.querySelector('footer')
            const cropBtn = document.querySelector("button");
            const cropImage = document.querySelector("img");
            const selectionBox = document.getElementById("selectionBox");


            window.electron.onLoadImageForCropping((imgDataURL) => {
                cropImage.src = imgDataURL;
                selectionBox.style.visibility = "visible";
                footer.style.visibility = 'visible';

                // Initialize selection box default dimensions and initial position
                selectionBox.style.width = "100px";
                selectionBox.style.height = "100px";
                selectionBox.style.left = "0";
                selectionBox.style.top = "0";
            });


            initSelectionBoxMovement(selectionBox, cropImage);
        })
    </script>
</body>

</html>